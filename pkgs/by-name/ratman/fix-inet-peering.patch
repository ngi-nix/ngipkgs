From 589ed89badd55f57d2844c562d2d9d639114771b Mon Sep 17 00:00:00 2001
From: June Stepp <git@junestepp.me>
Date: Mon, 25 Aug 2025 18:13:52 -0500
Subject: [PATCH] fix(netmod-inet): save correct peer router key ID

---
 netmods/netmod-inet/src/session.rs | 16 +++++++++++++---
 1 file changed, 13 insertions(+), 3 deletions(-)

diff --git a/netmods/netmod-inet/src/session.rs b/netmods/netmod-inet/src/session.rs
index ed1f53f1..2e505d9d 100644
--- a/netmods/netmod-inet/src/session.rs
+++ b/netmods/netmod-inet/src/session.rs
@@ -223,7 +223,7 @@ async fn handshake(
     };

     // ??? what does this match block actually do
-    let r_key_id = match (data.tt, ack) {
+    let peer_router_key_id = match (data.tt, ack) {
         (outgoing, Handshake::Ack { tt, r_key_id }) if outgoing == tt => {
             debug!("Handshake with {:?} was successful!", peer_addr);
             r_key_id
@@ -236,7 +236,17 @@ async fn handshake(
     };

     Ok((
-        Peer::standard(data, sender, Some(restart), write_stream, read_stream),
-        r_key_id,
+        Peer::standard(
+            // Current session data has an uninitialized `peer_router_key_id`
+            SessionData {
+                peer_router_key_id: peer_router_key_id,
+                ..data
+            },
+            sender,
+            Some(restart),
+            write_stream,
+            read_stream,
+        ),
+        peer_router_key_id,
     ))
 }
--
2.47.3

